version: '3.8'

services:
  # Main service with PX4 SITL + Gazebo + ROS2 (now uses new Gazebo by default)
  drone-control:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: drone_control_ros2_gz:latest
    container_name: drone_control_container
    hostname: drone-control
    privileged: true
    network_mode: host
    stdin_open: true
    tty: true
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - ROS_DOMAIN_ID=0
      - GZ_SIM_RESOURCE_PATH=/opt/px4_source/Tools/simulation/gz/models:/opt/px4_source/Tools/simulation/gz/worlds
      - PX4_GZ_MODELS=/opt/px4_source/Tools/simulation/gz/models
      - PX4_ROOT=/opt/px4_source
    volumes:
      - ..:/workspace
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /dev:/dev
    working_dir: /workspace
    command: bash

  # PX4 SITL with Gazebo simulation only
  gazebo-gz:
    image: drone_control_ros2_gz:latest
    container_name: gazebo_gz_container
    hostname: gazebo-gz-sim
    privileged: true
    network_mode: host
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - ROS_DOMAIN_ID=0
      - GZ_SIM_RESOURCE_PATH=/opt/px4_source/Tools/simulation/gz/models:/opt/px4_source/Tools/simulation/gz/worlds
      - PX4_GZ_MODELS=/opt/px4_source/Tools/simulation/gz/models
    volumes:
      - ..:/workspace
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    working_dir: /workspace
    command: /usr/local/bin/launch_gz_only.sh
    profiles:
      - gazebo-only

  # PX4 SITL with integrated ROS2 control (Gazebo version)
  px4-integrated:
    image: drone_control_ros2_gz:latest
    container_name: px4_integrated_container
    hostname: px4-integrated
    privileged: true
    network_mode: host
    stdin_open: true
    tty: true
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - ROS_DOMAIN_ID=0
      - GZ_SIM_RESOURCE_PATH=/opt/px4_source/Tools/simulation/gz/models:/opt/px4_source/Tools/simulation/gz/worlds
      - PX4_GZ_MODELS=/opt/px4_source/Tools/simulation/gz/models
      - PX4_ROOT=/opt/px4_source
    volumes:
      - ..:/workspace
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /dev:/dev
    ports:
      - "14540:14540/udp"
      - "14557:14557/udp"
      - "5600:5600/udp"
    working_dir: /workspace
    command: /usr/local/bin/start_integrated_system.sh
    profiles:
      - px4-full